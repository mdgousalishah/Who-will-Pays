<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Who Pays? - Modern Picker</title>
    <meta name="description" content="Fair random picker for tea, coffee, and bills.">
    <meta name="author" content="Kamel Shah">

    <!-- Fonts: Inter for Modern Look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Modern Violet/Pink Palette
                        primary: '#6366f1', // Indigo 500
                        'primary-dark': '#4f46e5', // Indigo 600
                        accent: '#ec4899', // Pink 500
                        success: '#10b981', // Emerald 500
                        dark: '#0f172a', // Slate 900
                        'glass-light': 'rgba(255, 255, 255, 0.7)',
                        'glass-dark': 'rgba(30, 41, 59, 0.7)',
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Roulette Text Gradient */
        .gradient-text {
            background: linear-gradient(135deg, #6366f1, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Animated Background */
        .bg-animated {
            background-size: 200% 200%;
            animation: gradientMove 15s ease infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark text-slate-800 dark:text-slate-200 min-h-screen transition-colors duration-300 overflow-x-hidden flex flex-col font-sans relative">

    <!-- Background Orbs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-300 dark:bg-purple-900 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-pink-300 dark:bg-pink-900 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-indigo-300 dark:bg-indigo-900 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

    <!-- Shuffle Overlay (Modern) -->
    <div id="shuffleOverlay" class="fixed inset-0 bg-dark/90 backdrop-blur-xl z-[100] hidden flex-col items-center justify-center transition-opacity duration-300">
        <div class="text-xs font-bold tracking-[0.4em] mb-12 text-gray-400 uppercase animate-pulse">Running Algorithm...</div>
        
        <div class="relative w-full max-w-sm h-40 flex items-center justify-center overflow-hidden">
            <div class="absolute inset-x-0 top-0 h-12 bg-gradient-to-b from-dark/90 to-transparent z-10"></div>
            <div class="absolute inset-x-0 bottom-0 h-12 bg-gradient-to-t from-dark/90 to-transparent z-10"></div>
            
            <div id="rouletteName" class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-500 scale-100 transition-all">
                ...
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="mt-10 flex gap-3">
             <div class="w-1.5 h-12 bg-indigo-500 rounded-full animate-[bounce_1s_infinite]"></div>
             <div class="w-1.5 h-12 bg-pink-500 rounded-full animate-[bounce_1s_infinite_0.1s]"></div>
             <div class="w-1.5 h-12 bg-purple-500 rounded-full animate-[bounce_1s_infinite_0.2s]"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 w-full max-w-md mx-auto p-4 flex-1 flex flex-col h-screen">
        
        <!-- Header -->
        <header class="flex items-center justify-between py-4 mb-2">
            <div class="flex items-center gap-3">
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-xl blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative w-10 h-10 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center border border-gray-200 dark:border-gray-700">
                         <img src="/kamel logo copy.png" alt="Logo" class="w-8 h-8 object-contain" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4206/4206236.png'">
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">Who Pays?</h1>
                </div>
            </div>
            <button id="themeToggle" class="w-10 h-10 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-slate-700 backdrop-blur-md transition-all flex items-center justify-center text-slate-600 dark:text-slate-300 border border-gray-200 dark:border-gray-700">
                <i class="fa-solid fa-moon"></i>
            </button>
        </header>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto no-scrollbar pb-32">
            
            <!-- Items Carousel -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-3 px-1">
                    <h2 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">Select Item</h2>
                </div>
                
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="itemsGrid">
                    <!-- JS Injected -->
                </div>
                
                <div class="mt-2 relative">
                    <input type="text" id="customItemInput" class="w-full bg-transparent border-b-2 border-gray-200 dark:border-gray-700 py-2 px-1 text-sm font-medium focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-400" placeholder="Or type custom item...">
                    <i class="fa-solid fa-pen absolute right-2 top-3 text-gray-400 text-xs"></i>
                </div>
            </div>

            <!-- Dashboard Card -->
            <div class="glass rounded-3xl p-5 mb-6 shadow-xl shadow-indigo-500/5 dark:shadow-black/20">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Cost per person</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">â‚¹</span>
                            <input type="number" id="priceInput" class="w-full bg-gray-50 dark:bg-slate-800/50 rounded-xl pl-8 pr-3 py-3 font-bold text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all" placeholder="0">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Participants</label>
                        <div class="w-full bg-gray-50 dark:bg-slate-800/50 rounded-xl px-4 py-3 font-bold text-slate-800 dark:text-white flex items-center justify-between border border-transparent">
                            <span id="countInputSync">0</span>
                            <i class="fa-solid fa-users text-gray-400 text-xs"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-4 text-white shadow-lg shadow-indigo-500/30 flex justify-between items-center">
                    <span class="text-xs font-medium opacity-80 uppercase tracking-wide">Total Amount</span>
                    <span id="grandTotalDisplay" class="text-2xl font-black">â‚¹0</span>
                </div>
            </div>

            <!-- Players Section -->
            <div class="mb-20">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h2 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">Participants</h2>
                    <button id="clearBtn" class="text-[10px] font-bold text-pink-500 hover:text-pink-400 transition-colors uppercase">Clear All</button>
                </div>

                <!-- Input Row -->
                <div class="relative mb-4 group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-pink-500 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-200"></div>
                    <div class="relative flex bg-white dark:bg-slate-800 rounded-xl p-1 shadow-sm">
                        <input type="text" id="newPlayerInput" class="flex-1 bg-transparent border-none px-4 text-sm focus:ring-0 focus:outline-none dark:text-white placeholder-gray-400" placeholder="Add name (e.g. Rahul)...">
                        <button id="addPlayerBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg w-10 h-10 flex items-center justify-center transition-colors">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Presets -->
                <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4">
                    <button onclick="loadPreset('Friends')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase bg-white dark:bg-slate-800 text-gray-500 border border-gray-200 dark:border-gray-700 hover:border-indigo-500 hover:text-indigo-500 transition-all shadow-sm">Friends</button>
                    <button onclick="loadPreset('Office')" class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase bg-white dark:bg-slate-800 text-gray-500 border border-gray-200 dark:border-gray-700 hover:border-indigo-500 hover:text-indigo-500 transition-all shadow-sm">Office</button>
                    <button id="addSampleBtn" class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase bg-orange-50 dark:bg-orange-900/20 text-orange-500 border border-orange-200 dark:border-orange-900/50 hover:bg-orange-100 transition-all shadow-sm">Add Samples</button>
                </div>

                <!-- List -->
                <div id="playerList" class="flex flex-wrap gap-2 content-start min-h-[50px]">
                    <div class="w-full text-center py-6 text-sm text-gray-400 italic opacity-50">
                        List is empty. Add someone above!
                    </div>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Action Area -->
        <div class="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-dark dark:via-dark dark:to-transparent z-20 pt-10">
            <button id="pickBtn" class="group relative w-full h-14 rounded-2xl overflow-hidden shadow-2xl shadow-indigo-500/40 transition-transform active:scale-95">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 bg-[length:200%_auto] animate-[gradientMove_3s_linear_infinite]"></div>
                <div class="relative h-full flex items-center justify-center gap-3 text-white font-bold text-lg tracking-wide uppercase">
                    <span>Who Pays?</span>
                    <i class="fa-solid fa-dice text-xl group-hover:rotate-180 transition-transform duration-500"></i>
                </div>
            </button>
            
            <div class="flex justify-between mt-3 px-2">
                <button onclick="toggleSettings()" class="text-[10px] font-bold text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 uppercase tracking-widest flex items-center gap-1">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
                <button onclick="showHistory()" class="text-[10px] font-bold text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 uppercase tracking-widest flex items-center gap-1">
                    <i class="fa-solid fa-clock-rotate-left"></i> History
                </button>
            </div>
        </div>

        <!-- Settings Modal (Hidden) -->
        <div id="settingsPanel" class="hidden absolute bottom-24 left-4 right-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-4 z-30 animate-pop-in">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Preferences</h3>
            <div class="space-y-3">
                <label class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm font-medium dark:text-gray-200">Exclude previous winner</span>
                    <input type="checkbox" id="excludePrev" class="accent-indigo-500 w-5 h-5" checked>
                </label>
                <label class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm font-medium dark:text-gray-200">Confetti Effects</span>
                    <input type="checkbox" id="confettiToggle" class="accent-pink-500 w-5 h-5" checked>
                </label>
                <button onclick="saveCurrentAsPreset()" class="w-full mt-2 py-2 text-xs font-bold uppercase border border-dashed border-gray-300 dark:border-gray-600 text-gray-500 rounded-lg hover:border-indigo-500 hover:text-indigo-500 transition-colors">
                    Save Current Group
                </button>
            </div>
        </div>

        <!-- History Modal (Hidden) -->
        <div id="historyPanel" class="hidden absolute bottom-24 left-4 right-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-4 z-30 animate-pop-in max-h-64 overflow-y-auto">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Recent Picks</h3>
                <button id="clearHistoryBtn" class="text-[10px] text-pink-500 font-bold uppercase">Clear</button>
            </div>
            <ul id="historyList" class="space-y-2">
                <!-- JS Injected -->
            </ul>
        </div>
    </div>

    <!-- Result Modal (Overlay) -->
    <div id="resultOverlay" class="fixed inset-0 bg-dark/80 backdrop-blur-md z-[90] hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-white/10 relative overflow-hidden animate-pop-in">
            <!-- decorative gradient -->
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-indigo-500/20 to-pink-500/20 blur-3xl rounded-full -translate-y-1/2"></div>
            
            <div class="relative text-center">
                <div class="w-16 h-16 mx-auto bg-gradient-to-br from-indigo-500 to-pink-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/30">
                    <i class="fa-solid fa-crown text-2xl text-white"></i>
                </div>
                
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-2">The Chosen One</h2>
                <div id="winnerName" class="text-4xl font-black text-slate-800 dark:text-white mb-2">Winner</div>
                <div id="winnerItem" class="text-lg font-medium text-indigo-500 mb-6">Tea</div>

                <!-- Safe List Compact -->
                <div class="bg-gray-50 dark:bg-slate-800/50 rounded-xl p-3 mb-6">
                    <p class="text-[10px] uppercase font-bold text-green-500 mb-2 flex items-center justify-center gap-1"><i class="fa-solid fa-shield-halved"></i> Safe</p>
                    <div id="safeList" class="flex flex-wrap justify-center gap-1.5"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="spinAgainBtn" class="py-3 rounded-xl bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                        Spin Again
                    </button>
                    <button id="shareBtn" class="py-3 rounded-xl bg-green-500 text-white font-bold text-sm hover:bg-green-600 shadow-lg shadow-green-500/30 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-brands fa-whatsapp"></i> Share
                    </button>
                </div>
            </div>
            
            <button onclick="closeResult()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs font-bold px-6 py-3 rounded-full shadow-xl opacity-0 pointer-events-none transition-all duration-300 z-[110] translate-y-[-20px]">
        Notification
    </div>

    <script>
        /**
         * WHO PAYS? - MODERN EDITION
         * Logic preserved, UI completely revamped.
         */

        // --- Data ---
        const ITEMS = [
            { id: 'tea', label: 'Tea', icon: 'fa-mug-hot', color: 'text-orange-500' },
            { id: 'coffee', label: 'Coffee', icon: 'fa-mug-saucer', color: 'text-amber-700' },
            { id: 'drinks', label: 'Drinks', icon: 'fa-glass-water', color: 'text-blue-400' },
            { id: 'lunch', label: 'Lunch', icon: 'fa-bowl-rice', color: 'text-red-500' },
            { id: 'pizza', label: 'Pizza', icon: 'fa-pizza-slice', color: 'text-yellow-500' },
            { id: 'snack', label: 'Snack', icon: 'fa-cookie', color: 'text-pink-500' },
        ];

        let state = {
            selectedItem: 'tea',
            customItem: 'Tea',
            names: [], // { name: string, isSample: boolean }
            history: [],
            lastWinner: null,
            theme: localStorage.getItem('wp_theme') || 'dark',
            totalAmount: 0
        };

        // --- DOM Cache ---
        const $ = (id) => document.getElementById(id);
        const els = {
            itemsGrid: $('itemsGrid'),
            customInput: $('customItemInput'),
            priceInput: $('priceInput'),
            countSync: $('countInputSync'),
            totalDisplay: $('grandTotalDisplay'),
            nameInput: $('newPlayerInput'),
            addBtn: $('addPlayerBtn'),
            playerList: $('playerList'),
            pickBtn: $('pickBtn'),
            shuffle: $('shuffleOverlay'),
            roulette: $('rouletteName'),
            result: $('resultOverlay'),
            winnerName: $('winnerName'),
            winnerItem: $('winnerItem'),
            safeList: $('safeList'),
            themeToggle: $('themeToggle'),
            historyList: $('historyList'),
            settingsPanel: $('settingsPanel'),
            historyPanel: $('historyPanel'),
            toast: $('toast'),
            confetti: $('confetti-canvas'),
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- Init ---
        function init() {
            renderItems();
            loadState();
            renderPlayers();
            renderHistory();
            updateMath();
            applyTheme();
            
            // Close modals on outside click
            document.addEventListener('click', (e) => {
                if(!els.settingsPanel.contains(e.target) && !e.target.closest("button[onclick='toggleSettings()']")) {
                    els.settingsPanel.classList.add('hidden');
                }
                if(!els.historyPanel.contains(e.target) && !e.target.closest("button[onclick='showHistory()']")) {
                    els.historyPanel.classList.add('hidden');
                }
            });
        }

        function loadState() {
            const saved = localStorage.getItem('wp_modern_names');
            if(saved) state.names = JSON.parse(saved);
            
            const hist = localStorage.getItem('wp_modern_history');
            if(hist) state.history = JSON.parse(hist);
        }

        function saveState() {
            localStorage.setItem('wp_modern_names', JSON.stringify(state.names));
        }

        // --- UI Renderers ---
        function renderItems() {
            els.itemsGrid.innerHTML = ITEMS.map(item => `
                <button onclick="selectItem('${item.id}')" 
                    class="flex flex-col items-center justify-center min-w-[70px] h-[70px] rounded-2xl transition-all duration-200 border ${state.selectedItem === item.id 
                    ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-500 scale-105 shadow-md' 
                    : 'bg-white dark:bg-slate-800 border-gray-100 dark:border-slate-700 opacity-70 grayscale hover:grayscale-0 hover:opacity-100'}">
                    <i class="fa-solid ${item.icon} text-xl mb-1 ${item.color}"></i>
                    <span class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase">${item.label}</span>
                </button>
            `).join('');
        }

        window.selectItem = (id) => {
            state.selectedItem = id;
            const item = ITEMS.find(i => i.id === id);
            if(item) {
                state.customItem = item.label;
                els.customInput.value = item.label;
            }
            renderItems();
        };

        els.customInput.addEventListener('input', (e) => {
            state.selectedItem = null;
            state.customItem = e.target.value;
            renderItems();
        });

        function renderPlayers() {
            if (state.names.length === 0) {
                els.playerList.innerHTML = `<div class="w-full text-center py-6 text-sm text-gray-400 italic opacity-50">List is empty. Add someone above!</div>`;
            } else {
                els.playerList.innerHTML = state.names.map((p, i) => `
                    <div class="animate-pop-in pl-3 pr-2 py-1.5 rounded-lg flex items-center gap-2 border text-sm font-medium transition-all ${p.isSample 
                        ? 'bg-orange-50/50 dark:bg-orange-900/10 border-orange-200 dark:border-orange-800 text-orange-600' 
                        : 'bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 shadow-sm'}">
                        <span>${p.name}</span>
                        ${p.isSample ? '<i class="fa-solid fa-flask text-[10px] opacity-50" title="Sample"></i>' : ''}
                        <button onclick="removePlayer(${i})" class="w-5 h-5 flex items-center justify-center rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark text-xs"></i></button>
                    </div>
                `).join('');
            }
        }

        // --- Actions ---
        els.addBtn.onclick = () => {
            const val = els.nameInput.value.trim();
            if(!val) return;
            val.split(/[\n,]+/).forEach(n => {
                if(n.trim()) state.names.push({ name: n.trim(), isSample: false });
            });
            els.nameInput.value = '';
            saveState();
            renderPlayers();
            updateMath();
        };

        els.nameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') els.addBtn.click(); });

        window.removePlayer = (i) => {
            state.names.splice(i, 1);
            saveState();
            renderPlayers();
            updateMath();
        };

        $('addSampleBtn').onclick = () => {
            ["Rahul", "Priya", "Amit", "Sneha"].forEach(n => state.names.push({ name: n, isSample: true }));
            saveState(); renderPlayers(); updateMath();
            toast("Samples added (Excluded from cost)");
        };

        $('clearBtn').onclick = () => {
            if(confirm("Remove everyone?")) { state.names = []; saveState(); renderPlayers(); updateMath(); }
        };

        function updateMath() {
            const billable = state.names.filter(n => !n.isSample).length;
            els.countSync.innerText = billable;
            
            const price = parseFloat(els.priceInput.value) || 0;
            state.totalAmount = billable * price;
            els.totalDisplay.innerText = `â‚¹${state.totalAmount.toLocaleString()}`;
        }
        els.priceInput.addEventListener('input', updateMath);

        // --- Picker Logic ---
        els.pickBtn.onclick = () => {
            if(state.names.length < 2) {
                toast("Need at least 2 people!");
                els.nameInput.focus();
                return;
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // Filter
            let candidates = state.names.map(p => p.name);
            const exclude = $('excludePrev').checked;
            if(exclude && state.lastWinner && candidates.includes(state.lastWinner) && candidates.length > 1) {
                candidates = candidates.filter(n => n !== state.lastWinner);
            }

            // Start Animation
            els.shuffle.classList.remove('hidden');
            els.shuffle.classList.add('flex');
            
            let steps = 0, speed = 50;
            let bag = [];
            
            const spin = () => {
                if(bag.length === 0) bag = [...candidates].sort(() => Math.random() - 0.5);
                const name = bag.pop();
                
                els.roulette.innerText = name;
                els.roulette.style.transform = `scale(${0.9 + Math.random()*0.2})`;
                playTone(200 + (steps*5), 'triangle', 0.05);

                steps++;
                if(steps < 35) {
                    if(steps > 25) speed += 30;
                    setTimeout(spin, speed);
                } else {
                    finishSpin(candidates);
                }
            };
            spin();
        };

        function finishSpin(candidates) {
            const winner = candidates[Math.floor(Math.random() * candidates.length)];
            state.lastWinner = winner;
            
            // Hide spinner, show result
            setTimeout(() => {
                els.shuffle.classList.add('hidden');
                els.shuffle.classList.remove('flex');
                
                els.winnerName.innerText = winner;
                const item = els.customInput.value || "Treats";
                els.winnerItem.innerHTML = state.totalAmount > 0 
                    ? `paying for <b>${item}</b> (â‚¹${state.totalAmount})` 
                    : `paying for <b>${item}</b>`;
                
                // Safe List
                const safe = state.names.map(p => p.name).filter(n => n !== winner);
                els.safeList.innerHTML = safe.length 
                    ? safe.map(n => `<span class="px-1.5 py-0.5 bg-green-100 dark:bg-green-900/30 text-[10px] text-green-600 dark:text-green-400 rounded">${n}</span>`).join('')
                    : '<span class="text-[10px] text-gray-400">Solo mission?</span>';

                els.result.classList.remove('hidden');
                els.result.classList.add('flex');
                
                playWinSound();
                if($('confettiToggle').checked) fireConfetti();
                
                addHistory(winner, item);
            }, 500);
        }

        window.closeResult = () => {
            els.result.classList.add('hidden');
            els.result.classList.remove('flex');
        };

        // --- History & Settings ---
        function addHistory(winner, item) {
            state.history.unshift({ 
                name: winner, 
                item: item, 
                amt: state.totalAmount, 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) 
            });
            if(state.history.length > 10) state.history.pop();
            localStorage.setItem('wp_modern_history', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            if(state.history.length === 0) {
                els.historyList.innerHTML = '<li class="text-xs text-center text-gray-400">Empty</li>';
                return;
            }
            els.historyList.innerHTML = state.history.map(h => `
                <li class="flex justify-between items-center text-xs py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                    <div>
                        <span class="font-bold text-indigo-500">${h.name}</span>
                        <span class="text-gray-400">for ${h.item}</span>
                    </div>
                    <span class="text-[10px] text-gray-300">${h.time}</span>
                </li>
            `).join('');
        }

        window.toggleSettings = () => {
            els.settingsPanel.classList.toggle('hidden');
            els.historyPanel.classList.add('hidden');
        };
        window.showHistory = () => {
            els.historyPanel.classList.toggle('hidden');
            els.settingsPanel.classList.add('hidden');
        };

        // --- Utils ---
        window.loadPreset = (key) => {
            const defaults = {
                'Friends': ["Buddy 1", "Buddy 2", "Buddy 3"],
                'Office': ["Boss", "Manager", "Intern"],
            };
            const list = defaults[key] || [];
            list.forEach(n => state.names.push({ name: n, isSample: false }));
            saveState(); renderPlayers(); updateMath();
            toast(`Added ${key}`);
        };

        window.saveCurrentAsPreset = () => {
            toast("Group saved locally!");
            // Logic placeholder
        };

        $('clearHistoryBtn').onclick = () => {
            state.history = [];
            localStorage.setItem('wp_modern_history', '[]');
            renderHistory();
        };

        $('spinAgainBtn').onclick = () => {
            closeResult();
            els.pickBtn.click();
        };

        $('shareBtn').onclick = () => {
            const txt = `ðŸ’¸ *${els.winnerName.innerText}* is paying for *${state.customItem}*!`;
            const area = document.createElement("textarea");
            area.value = txt; document.body.appendChild(area); area.select();
            document.execCommand('copy'); document.body.removeChild(area);
            toast("Result copied!");
        };

        // --- Visuals ---
        function toast(msg) {
            els.toast.innerText = msg;
            els.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => els.toast.classList.add('opacity-0', 'translate-y-[-20px]'), 2000);
        }

        function applyTheme() {
            if (state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                els.themeToggle.innerHTML = '<i class="fa-solid fa-sun text-yellow-400"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                els.themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
            }
        }
        els.themeToggle.onclick = () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('wp_theme', state.theme);
            applyTheme();
        };

        // Audio
        function playTone(freq, type, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.value = 0.05;
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }
        function playWinSound() {
            [400, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.2), i*100));
        }

        // Confetti
        function fireConfetti() {
            const canvas = els.confetti;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let p = Array(100).fill().map(() => ({
                x: canvas.width/2, y: canvas.height/2,
                vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
                c: `hsl(${Math.random()*360}, 100%, 50%)`, life: 100
            }));
            function anim() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let act = false;
                p.forEach(pt => {
                    if(pt.life<=0)return;
                    act=true; pt.x+=pt.vx; pt.y+=pt.vy; pt.vy+=0.5; pt.life--;
                    ctx.fillStyle=pt.c; ctx.fillRect(pt.x,pt.y,6,6);
                });
                if(act) requestAnimationFrame(anim);
            }
            anim();
        }

        init();
    </script>
</body>
</html>